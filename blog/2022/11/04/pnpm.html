<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Atom Feed"><title data-react-helmet="true">说实话，不得不用 pnpm 的原因，还得是电脑内存不够用 | My Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://jiaozitang.github.io/blog/2022/11/04/pnpm"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="说实话，不得不用 pnpm 的原因，还得是电脑内存不够用 | My Site"><meta data-react-helmet="true" name="description" content="本文介绍的是 pnpm 管理 Monorepo 项目实践。"><meta data-react-helmet="true" property="og:description" content="本文介绍的是 pnpm 管理 Monorepo 项目实践。"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2022-11-04T00:00:00.000Z"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://jiaozitang.github.io/blog/2022/11/04/pnpm"><link data-react-helmet="true" rel="alternate" href="https://jiaozitang.github.io/blog/2022/11/04/pnpm" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://jiaozitang.github.io/blog/2022/11/04/pnpm" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.1098517f.css">
<link rel="preload" href="/assets/js/runtime~main.5fde237b.js" as="script">
<link rel="preload" href="/assets/js/main.5fad3d91.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">My Site</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs/front-end/code">前端</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/jiaozitang/blog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">All posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a aria-current="page" class="sidebarItemLink_zyXk sidebarItemLinkActive_wcJs" href="/blog/2022/11/04/pnpm">说实话，不得不用 pnpm 的原因，还得是电脑内存不够用</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/09/19/rollup">【实战篇】最详细的Rollup打包项目教程</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/09/18/component">5 种瀑布流场景的实现原理解析</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/09/17/react-component">从0到1开发一个React组件库</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/09/08/ts">类型体操的9种类型运算、4种类型套路总结</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/09/04/git">20个常用的 Git 指令用法</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/08/28/lerna">lerna</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/08/14/hooks">hooks</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/07/31/devtools2">一些有用的 JavaScript 调试技巧</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/07/30/devtools1">devtools1</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/06/24/storybook">浅学一下 storybook</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/06/13/module-federation">浅学一下 webpack5 module federation</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/05/23/ts">Typescript 常用特性小结</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/03/12/function-code">JavaScript 函数式编程-入门篇</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/02/12/React-Hooks">React-你有完全了解 Hooks 吗</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/02/11/up-up-up">专栏学习心得《大厂晋升指南》</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/01/31/【译】你知道 Code Review 应该检查哪些问题吗">【译】你知道 Code Review 应该检查哪些问题吗</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/实践指南-快速搭建文档系统">实践指南-快速搭建文档系统</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2021/12/20/how-to-join-Taro">如何参与大型开源项目-Taro 共建</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2021/07/22/simple-react">手写系列-实现一个铂金段位的 React</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">说实话，不得不用 pnpm 的原因，还得是电脑内存不够用</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-11-04T00:00:00.000Z" itemprop="datePublished">November 4, 2022</time> · <!-- -->9 min read</div></header><div class="markdown" itemprop="articleBody"><p>本文介绍的是 pnpm 管理 Monorepo 项目实践。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="什么是-monorepo">什么是 Monorepo<a class="hash-link" href="#什么是-monorepo" title="Direct link to heading">​</a></h2><p>Monorepo 项目简称多包项目，一个包含多个子项目的仓库。</p><p>那为什么要放多个项目在一个仓库下呢？</p><p>是因为这些项目互相引用，相互依赖，放在一个仓库下方便管理及依赖。</p><p>所以管理一个多包项目的关键，需要实现以下 2 点：</p><ul><li>能够很方便的管理包与包之间的依赖关系</li><li>能够在发布其中一个包时，自动更新依赖了该包的其他包并发布</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="什么是-lerna">什么是 lerna<a class="hash-link" href="#什么是-lerna" title="Direct link to heading">​</a></h2><p>使用最广泛成熟的 Monorepe 项目管理方案就是 lerna + yarn。</p><p>lerna 是一个优化使用 git 和 npm 管理多包存储库工作流的工具。</p><p>它具有以下功能：</p><ul><li>自动解决 packages 之间的依赖关系；</li><li>通过 git 检测文件改动，自动发布；</li><li>根据 git 提交记录，自动生成 CHANGELOG。</li></ul><p>更多详细的 lerna 介绍可以见我的另外一篇博客：<a href="https://juejin.cn/post/7136925215388499998" target="_blank" rel="noopener noreferrer">最详细的 lerna 中文手册</a>。</p><p>既然 lerna 这么好用也这么熟悉了，那为什么还要切换到 pnpm 呢？</p><p>有以下几个原因：</p><ul><li>pnpm 内置了管理 monorepe 功能，使用起来比 lerna 简单</li><li>pnpm 安装比 yarn 高效，也节省电脑内存</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="什么是-pnpm">什么是 pnpm<a class="hash-link" href="#什么是-pnpm" title="Direct link to heading">​</a></h2><blockquote><p>pnpm 介绍可以查看 <a href="https://pnpm.io/zh/motivation" target="_blank" rel="noopener noreferrer">pnpm 官网</a>。</p></blockquote><p>pnpm 是新一代的包管理工具，相较于 npm 和 yarn，有以下 2 个优点：</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="节约磁盘空间并提升安装速度">节约磁盘空间并提升安装速度<a class="hash-link" href="#节约磁盘空间并提升安装速度" title="Direct link to heading">​</a></h3><p><strong>节约磁盘空间：</strong></p><ul><li><p>pnpm 安装依赖时，依赖会被存储在硬盘中，不同项目的同一依赖都会硬链接到硬盘位置，不会额外占用磁盘空间。</p></li><li><p>同一依赖包的不同版本，也只会将不同版本中有差异的文件添加到仓库中，不会下载整个包占用磁盘空间。</p></li></ul><p><strong>提升安装速度：</strong></p><ul><li>安装依赖时，会先去硬盘位置寻找包，如果能找到，则建立硬链接，比起重新下载包或者从缓存中拷贝移动包，速度快了很多</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="创建非扁平化的-node_modules-文件夹">创建非扁平化的 node_modules 文件夹<a class="hash-link" href="#创建非扁平化的-node_modules-文件夹" title="Direct link to heading">​</a></h3><p>npm、yarn 为了解决同一依赖被安装多次的问题，将所有包都被提升到模块目录的根目录。</p><p>但是当依赖包有多个版本的时候，只会提升一个，其余版本的包依然会被安装多次。</p><p>另外扁平化 node_modules 时，项目可以访问到未被添加进当前项目的依赖，这样是有隐患的，因为没有显式依赖，万一有一天别的包不依赖这个包了，代码就不能跑了，因为你依赖这个包，但是现在不会被安装了。</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5a8b229b8dcb4d7d8256d43d0d14973f~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>pnpm 采用磁盘硬链接连接依赖，已经解决了依赖会被安装多次的问题。</p><p>为了避免幽灵依赖，pnpm 选择创建非扁平化的 node_modules，项目无法访问到未被添加进当前项目的依赖。</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/570dc9ad20444043adbd1f1f83404f69~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="快速开始">快速开始<a class="hash-link" href="#快速开始" title="Direct link to heading">​</a></h2><p>上面已经了解到为什么选择 pnpm 了，那么下面就一起用 pnpm 来管理 Monorepo 吧。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="全局安装-pnpm">全局安装 pnpm<a class="hash-link" href="#全局安装-pnpm" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">nvm use </span><span class="token number" style="color:#36acaa">16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> i </span><span class="token function" style="color:#d73a49">pnpm</span><span class="token plain"> -g</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="创建-monorepo-项目">创建 Monorepo 项目<a class="hash-link" href="#创建-monorepo-项目" title="Direct link to heading">​</a></h3><p>创建目录结构：</p><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> my-project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> ./my-project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> init -y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> packages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> ./packages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> my-project-a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> ./my-project-a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> init -y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> my-project-b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> ./my-project-b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> init -y</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>启动 pnpm 的 workspace 功能，根目录新增 pnpm-workspace.yaml，指定工作空间的目录：</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">packages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;packages/**&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>项目结构如下：</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/54a1debe910e4142847a6800271f8b66~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>当我们配置了指定工作空间的目录后，<strong>packages 里的包互相引用时，会自动依赖本地编译的路径，方便实时调试</strong>。</p><p>至此我们就解决了 Monorepre 项目的管理包与包之间的依赖关系的问题。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="安装项目内依赖">安装项目内依赖<a class="hash-link" href="#安装项目内依赖" title="Direct link to heading">​</a></h3><p>限制仅允许 pnpm 安装依赖，更新 package.json：</p><div class="codeBlockContainer_J+bg language-json theme-code-block"><div class="codeBlockContent_csEI json"><pre tabindex="0" class="prism-code language-json codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;scripts&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;preinstall&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;npx only-allow pnpm&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>安装 eslint 等全局依赖：</p><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">pnpm</span><span class="token plain"> i eslint -w -D</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>安装子项目内独立的依赖：</p><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> ./packages/my-project-a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">pnpm</span><span class="token plain"> i rollup -D</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="发布流程">发布流程<a class="hash-link" href="#发布流程" title="Direct link to heading">​</a></h3><p>pnpm 没有提供内置的发布流程解决方案，官方推荐了两个开源的版本控制工具：</p><ul><li><a href="https://github.com/changesets/changesets" target="_blank" rel="noopener noreferrer">changesets</a></li><li><a href="https://rushjs.io/" target="_blank" rel="noopener noreferrer">rush</a></li></ul><p>changesets 的入手学习成本更低，于是乎选择了 changesets 来管理发布流程。</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="安装-changesets">安装 changesets<a class="hash-link" href="#安装-changesets" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">pnpm</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> -Dw @changesets/cli</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="初始化-changesets">初始化 changesets<a class="hash-link" href="#初始化-changesets" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">pnpm</span><span class="token plain"> changeset init</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>初始化后生成的 .changeset/config.json：</p><div class="codeBlockContainer_J+bg language-json theme-code-block"><div class="codeBlockContent_csEI json"><pre tabindex="0" class="prism-code language-json codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;$schema&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://unpkg.com/@changesets/config@2.1.1/schema.json&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;changelog&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;@changesets/cli/changelog&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// changelog 生成方式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;commit&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 不要让 changeset 在 publish 的时候帮我们做 git add</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;fixed&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;linked&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 配置哪些包要共享版本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;access&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;restricted&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 公私有安全设定，内网建议 restricted ，开源使用 public</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;baseBranch&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;master&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 项目主分支</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;updateInternalDependencies&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;patch&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 确保某包依赖的包发生 upgrade，该包也要发生 version upgrade 的衡量单位（量级）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;ignore&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 不需要变动 version 的包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="管理-changelog">管理 changelog<a class="hash-link" href="#管理-changelog" title="Direct link to heading">​</a></h4><p>如果是开源库可以安装 @changesets/changelog-github 来管理 changelog。</p><p>安装：</p><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">pnpm</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> -Dw @changesets/changelog-github</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>更新 .changeset/config.json：</p><div class="codeBlockContainer_J+bg language-json theme-code-block"><div class="codeBlockContent_csEI json"><pre tabindex="0" class="prism-code language-json codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;changelog&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;@changesets/changelog-github&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;repo&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;worktile/slate-angular&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 改为你的 github 仓储</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>如果不是开源库，则保持 <code>&quot;changelog&quot;: &quot;@changesets/cli/changelog&quot;</code>。</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="生成-changesets">生成 changesets<a class="hash-link" href="#生成-changesets" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">npx changeset</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>选择要发布的包：</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/54f9e9e354c742f0bf1fe2173b822c76~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>选择发布的类型：</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/539fba0b0adf4ba69ead6ce2ce0bba12~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>填写发布备注：</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4a845368dcf943b9b2eb955d12835884~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>确认发布：</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/588187cc8bc14ad8bf67b982c1e6b7d5~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>生成临时文件：</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/51887162db0f4454a21d14b73c57a10f~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="更新版本">更新版本<a class="hash-link" href="#更新版本" title="Direct link to heading">​</a></h4><p>更新版本前可以先把开发区的改动提交上去。</p><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> </span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> commit -m </span><span class="token string" style="color:#e3116c">&#x27;feat: msg&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> push</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>更新版本：</p><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">npx changeset version</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bf5a3d93527849829a227894690aa544~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>自动生成 CHANGELOG.md 并更新 package.json 中的版本，同时<strong>如果子项目间有相互依赖，也会更新依赖版本</strong>。</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/671efa2a72484b4a8617a293a5b8166b~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/176c4878b9774ee8bd7cf9836d20f169~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="发布版本">发布版本<a class="hash-link" href="#发布版本" title="Direct link to heading">​</a></h4><p>发布至 npm：</p><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">npx changeset publish</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>至此我们就解决了 Monorepre 项目的在发布其中一个包时，自动更新依赖了该包的其他包并发布的问题。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="小结">小结<a class="hash-link" href="#小结" title="Direct link to heading">​</a></h2><p>pnpm 是不是比 yarn + lerna 更香？节省磁盘空间，安装依赖更快，内置 Monorepo 功能。</p><p>说实话，不得不用 pnpm 的原因，还得是电脑内存不够用，20个项目，40G node_modules 的内存就没了。</p><p>所以，赶紧转 pnpm 吧。</p><p>项目地址：<a href="https://github.com/jiaozitang/web-learn-note/tree/feat/pnpm" target="_blank" rel="noopener noreferrer">https://github.com/jiaozitang/web-learn-note/tree/feat/pnpm</a></p><p>希望能对你有所帮助，感谢阅读～</p><p>别忘了点个赞鼓励一下我哦，笔芯 ❤️</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="参考资料">参考资料<a class="hash-link" href="#参考资料" title="Direct link to heading">​</a></h2><ul><li><a href="https://juejin.cn/post/7098609682519949325" target="_blank" rel="noopener noreferrer">pnpm + workspace + changesets 构建你的 monorepo 工程</a></li><li><a href="https://zhuanlan.zhihu.com/p/373935751" target="_blank" rel="noopener noreferrer">使用 pnpm 构建 Monorepo 项目</a></li><li><a href="https://juejin.cn/post/7054144427622826020" target="_blank" rel="noopener noreferrer">使用 Changesets 管理类库版本及更新日志</a></li><li><a href="https://juejin.cn/post/7127295203177676837" target="_blank" rel="noopener noreferrer">pnpm 是凭什么对 npm 和 yarn 降维打击的</a></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2022/09/19/rollup"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">【实战篇】最详细的Rollup打包项目教程<!-- --> »</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#什么是-monorepo" class="table-of-contents__link toc-highlight">什么是 Monorepo</a></li><li><a href="#什么是-lerna" class="table-of-contents__link toc-highlight">什么是 lerna</a></li><li><a href="#什么是-pnpm" class="table-of-contents__link toc-highlight">什么是 pnpm</a><ul><li><a href="#节约磁盘空间并提升安装速度" class="table-of-contents__link toc-highlight">节约磁盘空间并提升安装速度</a></li><li><a href="#创建非扁平化的-node_modules-文件夹" class="table-of-contents__link toc-highlight">创建非扁平化的 node_modules 文件夹</a></li></ul></li><li><a href="#快速开始" class="table-of-contents__link toc-highlight">快速开始</a><ul><li><a href="#全局安装-pnpm" class="table-of-contents__link toc-highlight">全局安装 pnpm</a></li><li><a href="#创建-monorepo-项目" class="table-of-contents__link toc-highlight">创建 Monorepo 项目</a></li><li><a href="#安装项目内依赖" class="table-of-contents__link toc-highlight">安装项目内依赖</a></li><li><a href="#发布流程" class="table-of-contents__link toc-highlight">发布流程</a></li></ul></li><li><a href="#小结" class="table-of-contents__link toc-highlight">小结</a></li><li><a href="#参考资料" class="table-of-contents__link toc-highlight">参考资料</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.5fde237b.js"></script>
<script src="/assets/js/main.5fad3d91.js"></script>
</body>
</html>